class ClearAll extends Monogatari.Action{static setup(){return monogatari.history("clear"),Promise.resolve()}static matchString([t]){return"clearall"===t}apply(){return monogatari.action("Dialog").reset({keepNVL:!0,saveNVL:!0}),monogatari.distractionFree(),Promise.resolve()}didApply(){const t=$_('[data-component="text-box"]').get(0);return monogatari.history("clear").push(t.props.mode),Promise.resolve({advance:!0})}}ClearAll.id="ClearAll",monogatari.registerAction(ClearAll);class ExtendBackground extends Monogatari.Action{static setup(){return monogatari.history("background"),monogatari.state({background:""}),monogatari.global("_scene_history_cleared_by_background",!1),Promise.resolve()}static onLoad(){const{background:t,scene:e}=monogatari.state();if("string"==typeof t&&""!==t&&""===e){const e=monogatari.prepareAction(t,{cycle:"Application"});return e.willApply().then(()=>e.apply().then(()=>e.didApply({updateHistory:!1,updateState:!1})))}return Promise.resolve()}static reset(){const t=$_('[data-ui="extend-background"]');return t.style("background-image","initial"),t.style("background-color","initial"),monogatari.state({extBackground:""}),Promise.resolve()}static matchString([t,e]){return"show"===t&&"ext-background"===e}constructor([t,e,a,...s]){if(super(),this.extBackground=a,this.property="background-image",void 0!==monogatari.asset("scenes",a))this.value=`url(${monogatari.setting("AssetsPath").root}/${monogatari.setting("AssetsPath").scenes}/${monogatari.asset("scenes",a)})`;else{const t=[a,...s].join(" ");s.indexOf("with")>-1?this.value=Text.prefix("with",t):this.value=t;const e=["#","rgb","hsl"].findIndex(t=>0===this.value.indexOf(t))>-1,i=!(this.value.indexOf(" ")>-1)&&(new RegExp(/\w+/).test(this.value)&&!new RegExp(/(url|gradient)\(/).test(this.value));!0!==e&&!0!==i||(this.property="background-color")}void 0!==s?this.classes=["animated",...s]:"remove"!==s?this.reset():this.classes=[]}willApply(){const t=$_('[data-ui="extend-background"]');return t.removeClass(),t.get(0).offsetWidth,Promise.resolve()}apply(){const t=$_('[data-ui="extend-background"]');$_('[data-ui="extend-background"]').style("background-image","initial"),$_('[data-ui="extend-background"]').style("background-color","initial"),$_('[data-ui="extend-background"]').style("animation-duration",""),$_('[data-ui="extend-background"]').style(this.property,this.value);const e=this.classes.indexOf("duration");e>-1&&t.style("animation-duration",this.classes[e+1]);for(const e of this.classes)t.addClass(e);return Promise.resolve()}didApply({updateHistory:t=!0,updateState:e=!0}={}){return!0===e&&monogatari.state({background:this._statement}),!0===t&&monogatari.history("background").push(this._statement),Promise.resolve({advance:!0})}}ExtendBackground.id="ExtendBackground",monogatari.registerAction(ExtendBackground);class HideImage extends Monogatari.Action{static matchString([t,e]){return"hide"===t&&"image"===e}constructor([t,e,a,...s]){super(),this.asset=a,this.element=monogatari.element().find(`[data-image="${this.asset}"]`),this.wrapper=monogatari.element().find("div .wrapper-image"),this.classes=void 0!==s?s:[],this.classes=this.classes.filter(t=>"at"!==t&&"with"!==t)}apply(){const t=this.element.data("position"),e=this._statement.match(/at\s(\S*)/),a=[...this.element.get(0).classList];for(const s of a)(s!==t||e instanceof Array)&&this.element.removeClass(s);if(e instanceof Array){const[t,a]=e;this.element.data("position",a)}this.wrapper.addClass("animated");const s=this.classes.indexOf("duration");if(s>-1?this.wrapper.style("animation-duration",this.classes[s+1]):this.wrapper.style("animation-duration",""),this.classes.length>0){for(const t of this.classes)this.wrapper.addClass(t);this.wrapper.data("visibility","invisible"),this.wrapper.on("animationend",t=>{"invisible"===t.target.dataset.visibility&&t.target.remove()})}else this.wrapper.remove();return this.element.remove(),Promise.resolve()}didApply(){const t=monogatari.state("images").filter(t=>{const[e,a,s]=t.split(" ");return s!==this.asset});return monogatari.state({images:t}),Promise.resolve({advance:!0})}willRevert(){return 0===monogatari.history("image").length?Promise.reject("Image history was empty."):Promise.resolve()}revert(){for(let t=monogatari.history("image").length-1;t>=0;t--){const e=monogatari.history("image")[t],[a,s,i]=e.split(" ");if(i===this.asset){const t=monogatari.prepareAction(e,{cycle:"Application"});return t.willApply().then(()=>t.apply().then(()=>t.didApply({updateHistory:!1,updateState:!0})))}}Promise.reject("Could not find a previous state to revert to")}didRevert(){return Promise.resolve({advance:!0,step:!0})}}HideImage.id="Hide::Image",monogatari.registerAction(HideImage);class ShowImage extends Monogatari.Action{static setup(){return monogatari.history("image"),monogatari.state({images:[]}),Promise.resolve()}static reset(){return monogatari.element().find('[data-screen="game"] [data-image]').remove(),monogatari.state({images:[]}),Promise.resolve()}static onLoad(){const{images:t}=monogatari.state(),e=[];for(const a of t){const t=monogatari.prepareAction(a,{cycle:"Application"}),s=t.willApply().then(()=>t.apply().then(()=>t.didApply({updateHistory:!1,updateState:!1})));e.push(s)}return e.length>0?Promise.all(e):Promise.resolve()}static matchString([t,e]){return"show"===t&&"image"===e}constructor([t,e,a,...s]){super(),this.asset=a,this.classes=(" "+s.join(" ")).replace(" at "," ").replace(" with "," ").trim().split(" "),void 0!==monogatari.asset("images",a)?this.image=monogatari.asset("images",a):this.image=a}apply(){const t=document.createElement("div"),e=document.createElement("img"),a=this._statement.match(/at\s(\S*)/);$_(t).addClass("wrapper-image"),$_(e).attribute("src",`${monogatari.setting("AssetsPath").root}/${monogatari.setting("AssetsPath").images}/${this.image}`),$_(t).addClass("animated"),$_(e).data("image",this.asset);for(const e of this.classes)e&&$_(t).addClass(e);if(a instanceof Array){const[t,s]=a;$_(e).data("position",s)}else $_(e).addClass("center"),$_(e).data("position","center");const s=this.classes.indexOf("duration");return s>-1&&$_(t).style("animation-duration",this.classes[s+1]),$_(t).append(e),monogatari.element().find('[data-screen="game"] [data-content="visuals"]').append(t.outerHTML),Promise.resolve()}didApply({updateHistory:t=!0,updateState:e=!0}={}){return!0===t&&monogatari.history("image").push(this._statement),!0===e&&monogatari.state({images:[...monogatari.state("images"),this._statement]}),Promise.resolve({advance:!0})}revert(){return monogatari.element().find(`[data-image="${this.asset}"]`).remove(),Promise.resolve()}didRevert(){return monogatari.history("image").pop(),monogatari.state({images:[...monogatari.state("images").filter(t=>{if("string"==typeof t){const[e,a,s]=t.split(" ");return s!==this.asset}})]}),Promise.resolve({advance:!0,step:!0})}}ShowImage.id="Show::Image",monogatari.registerAction(ShowImage);class Wait extends Monogatari.Action{static matchString([t]){return"wait"===t}constructor([t,e]){super(),isNaN(e)?void 0!==e&&Monogatari.FancyError.show("The specified time was not an integer","Monogatari attempted to transform the given time into an integer value but failed.",{"Specified time":e,Statement:`<code class='language=javascript'>"${this._statement}"</code>`,Label:monogatari.state("label"),Step:monogatari.state("step"),Help:{_:"Check if the value you provided is actually an integer (whole number). Remember the value used must be given in milliseconds and must not be mixed with characters other than numbers.",_1:"For example, the following statement would make the game wait for 5 seconds:",_3:"\n\t\t\t\t\t\t\t\t<pre><code class='language-javascript'>\"wait 5000\"</code></pre>\n\t\t\t\t\t\t\t"}}):this.time=parseInt(e)}apply(){return new Promise(t=>{"number"==typeof this.time?(monogatari.global("block",!0),setTimeout(()=>{monogatari.global("block",!1),!0===monogatari.global("distraction_free")&&monogatari.distractionFree(),t()},this.time)):t()})}didApply(){return"number"==typeof this.time?Promise.resolve({advance:!0}):Promise.resolve({advance:!1})}didRevert(){return Promise.resolve({advance:!0,step:!0})}}Wait.id="Wait",monogatari.registerAction(Wait);class Credit extends Monogatari.Action{static matchObject(t){return void 0!==t.Credit}constructor(t){super(),this.statement=t.Credit,this.fade_interval=3e3,this.scroll_speed=1500}apply(){return this.engine.global("block",!0),this.engine.element().find('[data-component="text-box"]').hide(),this.container=document.createElement("credits-container"),this.wrapper=document.createElement("div"),this.container.className="animated fadeIn",this.wrapper.className="wrapper",this.container.append(this.wrapper),this.engine.element().append(this.container),new Promise(t=>{this.runCredit().then(()=>{this.engine.global("block",!1),this.container.classList.remove("fadeIn"),this.container.classList.add("fadeOut"),this.container.addEventListener("animationend",()=>{this.container.remove(),t({advance:!0})})})})}didApply(){return Promise.resolve({advance:!0})}runCredit(){return"fade"in this.statement&&"scroll"in this.statement?new Promise(t=>{this.fadeStart(this.statement.fade).then(()=>{this.scrollStart(this.statement.scroll).then(()=>{t()})})}):"fade"in this.statement?this.fadeStart(this.statement.fade):"scroll"in this.statement?this.scrollStart(this.statement.scroll):Promise.resolve()}fadeStart(t){return this.container.classList.remove("credit-scroll"),this.container.classList.add("credit-fade"),new Promise(e=>{this.fade(t,0,e)})}fade(t,e,a){if(!(e in t))return void a();const s=t[e];"content"in s?this.fadeContent(s.title,s.content).then(()=>{this.fade(t,e+1,a)}):"list"in s&&this.fadeList(s.title,s.list).then(()=>{this.fade(t,e+1,a)})}fadeContent(t,e){let a=this.createElementContent(t,e);return a.classList.add("animated","fadeIn"),this.wrapper.append(a),new Promise(t=>{setTimeout(()=>{a.classList.remove("fadeIn"),a.classList.add("fadeOut"),a.addEventListener("animationend",()=>{a.remove(),t()})},this.fade_interval)})}fadeList(t,e){let a=this.createElementList(t,e);return a.classList.add("animated","fadeIn"),this.wrapper.append(a),new Promise(t=>{setTimeout(()=>{a.classList.remove("fadeIn"),a.classList.add("fadeOut"),a.addEventListener("animationend",()=>{a.remove(),t()})},this.fade_interval)})}scrollStart(t){return this.container.classList.remove("credit-fade"),this.container.classList.add("credit-scroll"),new Promise(e=>{this.scroll(t,e)})}scroll(t,e){for(const e in t){const a=t[e];if("content"in a){let t=this.createElementContent(a.title,a.content);this.wrapper.append(t)}else if("list"in a){let t=this.createElementList(a.title,a.list);this.wrapper.append(t)}}let a=Math.round(this.wrapper.clientHeight/100*this.scroll_speed),s=Math.round(this.wrapper.clientHeight+window.innerHeight);this.wrapper.style.setProperty("transition","transform "+a+"ms linear"),this.wrapper.style.setProperty("transform","translateY(-"+s+"px)"),this.wrapper.addEventListener("transitionend",()=>{e()})}createElementContent(t,e){let a=Array.isArray(e)?e:[e],s=document.createElement("div"),i=document.createElement("h1"),r=document.createElement("div");s.className="credit-section",i.textContent=t;for(const t in a){let e=document.createElement("p");e.textContent=a[t],r.append(e)}return s.append(i),s.append(r),s}createElementList(t,e){let a=Array.isArray(e),s=document.createElement("div"),i=document.createElement("h1"),r=document.createElement("dl");s.className="credit-section",i.textContent=t;for(const t in e){if(!a){let e=document.createElement("dt");e.textContent=t,r.append(e)}let s=document.createElement("dd");if(Array.isArray(e[t]))for(const a in e[t]){let i=document.createElement("p");i.textContent=e[t][a],s.append(i)}else s.textContent=e[t];r.append(s)}return s.append(i),s.append(r),s}revert(){return Promise.resolve()}}